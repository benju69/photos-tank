<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Photos Tank - Easy Guest Photo Sharing</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      color: white;
      margin-bottom: 40px;
    }

    .header h1 {
      font-size: 3em;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }

    .header p {
      font-size: 1.2em;
      opacity: 0.9;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
    }

    .btn:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .input-group {
      margin-bottom: 20px;
    }

    .input-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }

    .input-group input,
    .input-group textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    .input-group input:focus,
    .input-group textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    .qr-container {
      text-align: center;
      padding: 20px;
      background: #f5f5f5;
      border-radius: 8px;
      margin-top: 20px;
    }

    .qr-container img {
      max-width: 300px;
      border: 4px solid white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .share-link {
      background: #f0f0f0;
      padding: 15px;
      border-radius: 6px;
      margin-top: 15px;
      word-break: break-all;
      font-family: monospace;
      font-size: 14px;
    }

    .gallery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .gallery-item {
      position: relative;
      background: #f5f5f5;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: transform 0.3s;
    }

    .gallery-item:hover {
      transform: translateY(-4px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.2);
    }

    .gallery-item img,
    .gallery-item video {
      width: 100%;
      height: 250px;
      object-fit: cover;
    }

    .gallery-item-info {
      padding: 15px;
      background: white;
    }

    .gallery-item-info .guest-name {
      font-weight: 600;
      color: #667eea;
      margin-bottom: 5px;
    }

    .gallery-item-info .message {
      font-size: 14px;
      color: #666;
      font-style: italic;
    }

    .file-upload-area {
      border: 3px dashed #667eea;
      border-radius: 8px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: #f8f9ff;
    }

    .file-upload-area:hover {
      background: #eef1ff;
      border-color: #5568d3;
    }

    .file-upload-area.drag-over {
      background: #eef1ff;
      border-color: #5568d3;
      transform: scale(1.02);
    }

    .file-preview {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 20px;
    }

    .file-preview-item {
      position: relative;
      width: 100px;
      height: 100px;
      border-radius: 6px;
      overflow: hidden;
      border: 2px solid #e0e0e0;
    }

    .file-preview-item img,
    .file-preview-item video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .file-preview-item .file-name {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 5px;
      font-size: 10px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .hidden {
      display: none;
    }

    .events-list {
      display: grid;
      gap: 15px;
    }

    .event-card {
      background: #f8f9ff;
      padding: 20px;
      border-radius: 8px;
      border-left: 4px solid #667eea;
      cursor: pointer;
      transition: all 0.3s;
    }

    .event-card:hover {
      background: #eef1ff;
      transform: translateX(5px);
    }

    .event-card h3 {
      color: #333;
      margin-bottom: 5px;
    }

    .event-card p {
      color: #666;
      font-size: 14px;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
    }

    .tab {
      flex: 1;
      padding: 15px;
      background: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s;
      color: #666;
    }

    .tab.active {
      background: #667eea;
      color: white;
    }

    .success-message {
      background: #4caf50;
      color: white;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
      text-align: center;
      font-weight: 600;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .download-btn {
      background: #4caf50;
      margin-top: 20px;
    }

    .download-btn:hover {
      background: #45a049;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üì∏ Photos Tank</h1>
      <p>Easy Guest Photo Sharing for Weddings & Events</p>
    </div>

    <!-- Main Content Area -->
    <div id="app"></div>
  </div>

  <script>
    const API_BASE = window.location.origin;
    
    // State management
    let currentView = 'home';
    let currentEvent = null;
    let selectedFiles = [];
    let galleryRefreshInterval = null;
    let objectURLs = [];

    // HTML escape function to prevent XSS
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Clean up object URLs to prevent memory leaks
    function revokeObjectURLs() {
      objectURLs.forEach(url => URL.revokeObjectURL(url));
      objectURLs = [];
    }

    // Clear gallery refresh interval
    function clearGalleryInterval() {
      if (galleryRefreshInterval) {
        clearInterval(galleryRefreshInterval);
        galleryRefreshInterval = null;
      }
    }
    
    // Initialize app
    function init() {
      const pathParts = window.location.pathname.split('/');
      if (pathParts[1] === 'event' && pathParts[2]) {
        const eventId = pathParts[2];
        loadGuestView(eventId);
      } else if (pathParts[1] === 'admin' && pathParts[2]) {
        const eventId = pathParts[2];
        loadAdminView(eventId);
      } else {
        render();
      }
    }

    // Render main view
    function render() {
      const app = document.getElementById('app');
      
      if (currentView === 'home') {
        app.innerHTML = `
          <div class="tabs">
            <button class="tab active" onclick="switchTab('create', this)">Create Event</button>
            <button class="tab" onclick="switchTab('myEvents', this)">My Events</button>
          </div>
          <div id="tabContent"></div>
        `;
        switchTab('create');
      }
    }

    function switchTab(tab, clickedElement) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      if (clickedElement) {
        clickedElement.classList.add('active');
      } else {
        // When called programmatically, find the tab by its content
        const tabs = document.querySelectorAll('.tab');
        tabs.forEach(t => {
          if (t.textContent.includes(tab === 'create' ? 'Create' : 'My Events')) {
            t.classList.add('active');
          }
        });
      }
      
      const content = document.getElementById('tabContent');
      
      if (tab === 'create') {
        content.innerHTML = `
          <div class="card">
            <h2>Create New Event</h2>
            <form onsubmit="handleCreateEvent(event)">
              <div class="input-group">
                <label for="eventName">Event Name</label>
                <input type="text" id="eventName" placeholder="e.g., Sarah & John's Wedding" required>
              </div>
              <div class="input-group">
                <label for="eventDescription">Description (optional)</label>
                <textarea id="eventDescription" rows="3" placeholder="Share memories from our special day!"></textarea>
              </div>
              <button type="submit" class="btn">Create Event Gallery</button>
            </form>
          </div>
        `;
      } else if (tab === 'myEvents') {
        loadMyEvents();
      }
    }

    async function handleCreateEvent(e) {
      e.preventDefault();
      
      const name = document.getElementById('eventName').value;
      const description = document.getElementById('eventDescription').value;
      
      try {
        const response = await fetch(`${API_BASE}/api/events`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, description })
        });
        
        const event = await response.json();
        showEventDetails(event);
      } catch (error) {
        alert('Failed to create event: ' + error.message);
      }
    }

    function showEventDetails(event) {
      const content = document.getElementById('tabContent');
      const card = document.createElement('div');
      card.className = 'card';
      
      const title = document.createElement('h2');
      title.textContent = 'üéâ Event Created Successfully!';
      card.appendChild(title);
      
      const eventName = document.createElement('h3');
      eventName.textContent = event.name;
      card.appendChild(eventName);
      
      if (event.description) {
        const desc = document.createElement('p');
        desc.textContent = event.description;
        card.appendChild(desc);
      }
      
      const qrContainer = document.createElement('div');
      qrContainer.className = 'qr-container';
      qrContainer.innerHTML = `
        <h4>Share this QR Code with your guests</h4>
        <img src="${escapeHtml(event.qrCode)}" alt="Event QR Code">
        <div class="share-link">
          <strong>Or share this link:</strong><br>
          <a href="${escapeHtml(event.link)}" target="_blank">${escapeHtml(event.link)}</a>
        </div>
      `;
      card.appendChild(qrContainer);
      
      const buttonDiv = document.createElement('div');
      buttonDiv.style.marginTop = '30px';
      buttonDiv.style.textAlign = 'center';
      buttonDiv.innerHTML = `
        <button class="btn" onclick="window.location.href='/admin/${escapeHtml(event.id)}'">
          Manage Event & View Gallery
        </button>
      `;
      card.appendChild(buttonDiv);
      
      content.innerHTML = '';
      content.appendChild(card);
    }

    async function loadMyEvents() {
      const content = document.getElementById('tabContent');
      content.innerHTML = `
        <div class="card">
          <h2>My Events</h2>
          <div class="loading">
            <div class="spinner"></div>
            Loading events...
          </div>
        </div>
      `;
      
      try {
        const response = await fetch(`${API_BASE}/api/events`);
        const events = await response.json();
        
        const card = document.createElement('div');
        card.className = 'card';
        
        const title = document.createElement('h2');
        title.textContent = 'My Events';
        card.appendChild(title);
        
        if (events.length === 0) {
          const msg = document.createElement('p');
          msg.textContent = 'No events yet. Create your first event to get started!';
          card.appendChild(msg);
        } else {
          const eventsList = document.createElement('div');
          eventsList.className = 'events-list';
          
          events.forEach(event => {
            const eventCard = document.createElement('div');
            eventCard.className = 'event-card';
            eventCard.onclick = () => window.location.href = `/admin/${escapeHtml(event.id)}`;
            
            const eventTitle = document.createElement('h3');
            eventTitle.textContent = event.name;
            eventCard.appendChild(eventTitle);
            
            const uploads = document.createElement('p');
            uploads.textContent = `${event.uploads ? event.uploads.length : 0} uploads`;
            eventCard.appendChild(uploads);
            
            const created = document.createElement('p');
            created.style.fontSize = '12px';
            created.style.color = '#999';
            created.textContent = `Created: ${new Date(event.createdAt).toLocaleDateString()}`;
            eventCard.appendChild(created);
            
            eventsList.appendChild(eventCard);
          });
          
          card.appendChild(eventsList);
        }
        
        content.innerHTML = '';
        content.appendChild(card);
      } catch (error) {
        content.innerHTML = `
          <div class="card">
            <h2>My Events</h2>
            <p>Failed to load events: ${escapeHtml(error.message)}</p>
          </div>
        `;
      }
    }

    async function loadGuestView(eventId) {
      const app = document.getElementById('app');
      
      try {
        const response = await fetch(`${API_BASE}/api/events/${eventId}`);
        if (!response.ok) throw new Error('Event not found');
        const event = await response.json();
        
        app.innerHTML = `
          <div class="card">
            <h2>üì∏ ${event.name}</h2>
            ${event.description ? `<p>${event.description}</p>` : ''}
            <p style="color: #666; margin-top: 10px;">Share your photos, videos and messages!</p>
            
            <form onsubmit="handleUploadFiles(event, '${eventId}')">
              <div class="input-group">
                <label for="guestName">Your Name</label>
                <input type="text" id="guestName" placeholder="Enter your name" required>
              </div>
              
              <div class="input-group">
                <label for="guestMessage">Message (optional)</label>
                <textarea id="guestMessage" rows="2" placeholder="Add a message..."></textarea>
              </div>
              
              <div class="file-upload-area" id="dropZone" onclick="document.getElementById('fileInput').click()">
                <input type="file" id="fileInput" multiple accept="image/*,video/*" style="display: none;" onchange="handleFileSelect(event)">
                <p>üìÅ Click to select or drag files here</p>
                <p style="font-size: 14px; color: #666; margin-top: 10px;">Photos and videos accepted</p>
              </div>
              
              <div id="filePreview" class="file-preview"></div>
              
              <button type="submit" class="btn" style="width: 100%; margin-top: 20px;" id="uploadBtn" disabled>
                Upload Files
              </button>
            </form>
            
            <div id="uploadSuccess" class="success-message hidden"></div>
          </div>
          
          <div class="card">
            <h3>Gallery</h3>
            <div id="gallery" class="loading">
              <div class="spinner"></div>
              Loading gallery...
            </div>
          </div>
        `;
        
        setupDragDrop();
        loadGallery(eventId);
        
      } catch (error) {
        app.innerHTML = `
          <div class="card">
            <h2>Event Not Found</h2>
            <p>Sorry, this event doesn't exist or has been removed.</p>
            <button class="btn" onclick="window.location.href='/'">Go Home</button>
          </div>
        `;
      }
    }

    async function loadAdminView(eventId) {
      // Clear any existing interval
      clearGalleryInterval();
      
      const app = document.getElementById('app');
      
      try {
        const response = await fetch(`${API_BASE}/api/events/${eventId}`);
        if (!response.ok) throw new Error('Event not found');
        const event = await response.json();
        
        const container = document.createElement('div');
        
        // First card
        const card1 = document.createElement('div');
        card1.className = 'card';
        
        const title = document.createElement('h2');
        title.textContent = `üéâ ${event.name}`;
        card1.appendChild(title);
        
        if (event.description) {
          const desc = document.createElement('p');
          desc.textContent = event.description;
          card1.appendChild(desc);
        }
        
        const qrContainer = document.createElement('div');
        qrContainer.className = 'qr-container';
        qrContainer.innerHTML = `
          <h4>Share with Guests</h4>
          <img src="${escapeHtml(event.qrCode)}" alt="Event QR Code" style="max-width: 200px;">
          <div class="share-link">
            <strong>Guest Link:</strong><br>
            <a href="${escapeHtml(event.link)}" target="_blank">${escapeHtml(event.link)}</a>
          </div>
        `;
        card1.appendChild(qrContainer);
        
        const downloadBtn = document.createElement('button');
        downloadBtn.className = 'btn download-btn';
        downloadBtn.style.width = '100%';
        downloadBtn.textContent = 'üì• Download All Photos & Videos (ZIP)';
        downloadBtn.onclick = () => downloadGallery(eventId, event.name);
        card1.appendChild(downloadBtn);
        
        const backDiv = document.createElement('div');
        backDiv.style.marginTop = '20px';
        backDiv.style.textAlign = 'center';
        backDiv.innerHTML = `
          <button class="btn" onclick="clearGalleryInterval(); window.location.href='/'">
            ‚Üê Back to Events
          </button>
        `;
        card1.appendChild(backDiv);
        
        container.appendChild(card1);
        
        // Second card
        const card2 = document.createElement('div');
        card2.className = 'card';
        
        const galleryTitle = document.createElement('h3');
        galleryTitle.textContent = `Event Gallery (${event.uploads ? event.uploads.length : 0} uploads)`;
        card2.appendChild(galleryTitle);
        
        const galleryDiv = document.createElement('div');
        galleryDiv.id = 'gallery';
        galleryDiv.className = 'loading';
        galleryDiv.innerHTML = '<div class="spinner"></div>Loading gallery...';
        card2.appendChild(galleryDiv);
        
        container.appendChild(card2);
        
        app.innerHTML = '';
        app.appendChild(container);
        
        loadGallery(eventId);
        
        // Auto-refresh gallery every 10 seconds
        galleryRefreshInterval = setInterval(() => loadGallery(eventId), 10000);
        
      } catch (error) {
        app.innerHTML = `
          <div class="card">
            <h2>Event Not Found</h2>
            <p>Sorry, this event doesn't exist or has been removed.</p>
            <button class="btn" onclick="window.location.href='/'">Go Home</button>
          </div>
        `;
      }
    }

    function setupDragDrop() {
      const dropZone = document.getElementById('dropZone');
      
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('drag-over');
      });
      
      dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('drag-over');
      });
      
      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        const files = Array.from(e.dataTransfer.files);
        handleFiles(files);
      });
    }

    function handleFileSelect(e) {
      const files = Array.from(e.target.files);
      handleFiles(files);
    }

    function handleFiles(files) {
      const MAX_FILE_SIZE_PER_FILE = 100 * 1024 * 1024; // 100MB
      const validFiles = files.filter(file => file.size <= MAX_FILE_SIZE_PER_FILE);
      
      if (validFiles.length !== files.length) {
        alert('Some files were too large and have been skipped. Maximum size is 100MB per file.');
      }
      
      selectedFiles = validFiles;
      displayFilePreview(validFiles);
      document.getElementById('uploadBtn').disabled = validFiles.length === 0;
    }

    function displayFilePreview(files) {
      // Clean up previous object URLs
      revokeObjectURLs();
      
      const preview = document.getElementById('filePreview');
      preview.innerHTML = '';
      
      files.forEach(file => {
        const item = document.createElement('div');
        item.className = 'file-preview-item';
        
        if (file.type.startsWith('image/')) {
          const img = document.createElement('img');
          const url = URL.createObjectURL(file);
          objectURLs.push(url);
          img.src = url;
          item.appendChild(img);
        } else if (file.type.startsWith('video/')) {
          const video = document.createElement('video');
          const url = URL.createObjectURL(file);
          objectURLs.push(url);
          video.src = url;
          item.appendChild(video);
        }
        
        const fileName = document.createElement('div');
        fileName.className = 'file-name';
        fileName.textContent = file.name;
        item.appendChild(fileName);
        
        preview.appendChild(item);
      });
    }

    async function handleUploadFiles(e, eventId) {
      e.preventDefault();
      
      const guestName = document.getElementById('guestName').value;
      const message = document.getElementById('guestMessage').value;
      const uploadBtn = document.getElementById('uploadBtn');
      
      if (selectedFiles.length === 0) {
        alert('Please select files to upload');
        return;
      }
      
      uploadBtn.disabled = true;
      uploadBtn.textContent = 'Uploading...';
      
      try {
        const formData = new FormData();
        selectedFiles.forEach(file => {
          formData.append('files', file);
        });
        formData.append('guestName', guestName);
        formData.append('message', message);
        
        const response = await fetch(`${API_BASE}/api/events/${eventId}/upload`, {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        // Show success message
        const successDiv = document.getElementById('uploadSuccess');
        successDiv.textContent = result.message;
        successDiv.classList.remove('hidden');
        
        // Reset form
        document.getElementById('guestMessage').value = '';
        document.getElementById('fileInput').value = '';
        selectedFiles = [];
        revokeObjectURLs();
        document.getElementById('filePreview').innerHTML = '';
        uploadBtn.disabled = true;
        uploadBtn.textContent = 'Upload Files';
        
        // Reload gallery
        loadGallery(eventId);
        
        // Hide success message after 5 seconds
        setTimeout(() => {
          successDiv.classList.add('hidden');
        }, 5000);
        
      } catch (error) {
        alert('Upload failed: ' + error.message);
        uploadBtn.disabled = false;
        uploadBtn.textContent = 'Upload Files';
      }
    }

    async function loadGallery(eventId) {
      const gallery = document.getElementById('gallery');
      if (!gallery) return;
      
      try {
        const response = await fetch(`${API_BASE}/api/events/${eventId}/gallery`);
        const data = await response.json();
        
        if (!data.uploads || data.uploads.length === 0) {
          gallery.innerHTML = '<p style="text-align: center; color: #666;">No uploads yet. Be the first to share!</p>';
          return;
        }
        
        // Sort by upload time (newest first)
        const sortedUploads = data.uploads.sort((a, b) => 
          new Date(b.uploadedAt) - new Date(a.uploadedAt)
        );
        
        const galleryGrid = document.createElement('div');
        galleryGrid.className = 'gallery-grid';
        
        sortedUploads.forEach(upload => {
          const item = document.createElement('div');
          item.className = 'gallery-item';
          
          // Create media element
          if (upload.type.startsWith('image/')) {
            const img = document.createElement('img');
            img.src = escapeHtml(upload.path);
            img.alt = escapeHtml(upload.originalName);
            item.appendChild(img);
          } else {
            const video = document.createElement('video');
            video.src = escapeHtml(upload.path);
            video.controls = true;
            item.appendChild(video);
          }
          
          // Create info section
          const info = document.createElement('div');
          info.className = 'gallery-item-info';
          
          const guestName = document.createElement('div');
          guestName.className = 'guest-name';
          guestName.textContent = `üë§ ${upload.guestName}`;
          info.appendChild(guestName);
          
          if (upload.message) {
            const message = document.createElement('div');
            message.className = 'message';
            message.textContent = `"${upload.message}"`;
            info.appendChild(message);
          }
          
          const timestamp = document.createElement('div');
          timestamp.style.fontSize = '12px';
          timestamp.style.color = '#999';
          timestamp.style.marginTop = '5px';
          timestamp.textContent = new Date(upload.uploadedAt).toLocaleString();
          info.appendChild(timestamp);
          
          item.appendChild(info);
          galleryGrid.appendChild(item);
        });
        
        gallery.innerHTML = '';
        gallery.appendChild(galleryGrid);
      } catch (error) {
        const errorMsg = document.createElement('p');
        errorMsg.style.color = 'red';
        errorMsg.textContent = `Failed to load gallery: ${error.message}`;
        gallery.innerHTML = '';
        gallery.appendChild(errorMsg);
      }
    }

    async function downloadGallery(eventId, eventName) {
      try {
        window.location.href = `${API_BASE}/api/events/${eventId}/download`;
      } catch (error) {
        alert('Download failed: ' + error.message);
      }
    }

    // Initialize on page load
    init();
  </script>
</body>
</html>
